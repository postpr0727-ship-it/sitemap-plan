<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Sitemap Planner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- íŒŒë¹„ì½˜ -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%23000'/%3E%3Cg fill='none' stroke='%2300ff00' stroke-width='2'%3E%3Cpath d='M16 4 L16 12 M8 12 L16 12 L24 12 M8 12 L8 20 M24 12 L24 20 M8 20 L8 28 M24 20 L24 28'/%3E%3C/g%3E%3Ccircle cx='16' cy='4' r='2' fill='%2300ff00'/%3E%3Ccircle cx='8' cy='12' r='2' fill='%2300ff00'/%3E%3Ccircle cx='24' cy='12' r='2' fill='%2300ff00'/%3E%3Ccircle cx='8' cy='20' r='2' fill='%2300ff00'/%3E%3Ccircle cx='24' cy='20' r='2' fill='%2300ff00'/%3E%3Ccircle cx='8' cy='28' r='2' fill='%2300ff00'/%3E%3Ccircle cx='24' cy='28' r='2' fill='%2300ff00'/%3E%3C/svg%3E" />
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <!-- í”½ì…€ í°íŠ¸ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
      /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
      * {
        scrollbar-width: thin;
        scrollbar-color: rgba(100, 116, 139, 0.5) transparent;
      }
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, rgba(100, 116, 139, 0.6), rgba(71, 85, 105, 0.6));
        border-radius: 999px;
        border: 2px solid transparent;
        background-clip: padding-box;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, rgba(100, 116, 139, 0.8), rgba(71, 85, 105, 0.8));
        background-clip: padding-box;
      }
      ::-webkit-scrollbar-track {
        background-color: transparent;
      }

      /* ì• ë‹ˆë©”ì´ì…˜ ì •ì˜ */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      @keyframes shimmer {
        0% {
          background-position: -1000px 0;
        }
        100% {
          background-position: 1000px 0;
        }
      }

      /* ê·¸ë¼ë°ì´ì…˜ ë°°ê²½ */
      body {
        background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
        background-size: 400% 400%;
        animation: gradientShift 15s ease infinite;
      }

      @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }

      /* ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ íš¨ê³¼ */
      .glass {
        background: rgba(15, 23, 42, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(148, 163, 184, 0.1);
      }

      /* ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ */
      .btn-hover-glow:hover {
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
        transform: translateY(-1px);
      }

      /* ì¹´ë“œ ì• ë‹ˆë©”ì´ì…˜ */
      .card-fade-in {
        animation: fadeIn 0.5s ease-out;
      }

      /* ë“œë˜ê·¸ ì¤‘ì¸ ìš”ì†Œ */
      .dragging {
        opacity: 0.5;
        transform: scale(0.95);
        transition: all 0.2s ease;
      }

      /* ë„¤ì˜¨ ê·¸ë¼ë°ì´ì…˜ í…ìŠ¤íŠ¸ */
      .neon-text {
        background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6);
        background-size: 200% auto;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: shimmer 3s linear infinite;
      }

      /* ë°˜ì§ì´ëŠ” í…Œë‘ë¦¬ íš¨ê³¼ */
      .glow-border {
        position: relative;
        overflow: hidden;
      }

      .glow-border::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, #10b981, #3b82f6, #8b5cf6, #10b981);
        background-size: 400%;
        border-radius: inherit;
        opacity: 0;
        transition: opacity 0.3s;
        animation: shimmer 3s linear infinite;
        z-index: -1;
      }

      .glow-border:hover::before {
        opacity: 0.5;
      }

      /* ë¶€ë“œëŸ¬ìš´ íŠ¸ëœì§€ì…˜ */
      * {
        transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
      }

      button, a {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* í…Œì´ë¸” í–‰ í˜¸ë²„ */
      #page-table-body tr {
        transition: all 0.2s ease;
      }

      #page-table-body tr:hover {
        background: linear-gradient(90deg, rgba(16, 185, 129, 0.05), rgba(59, 130, 246, 0.05));
        transform: translateX(2px);
      }


      /* ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤ íš¨ê³¼ */
      input:focus, textarea:focus, select:focus {
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1), 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
      }
    </style>
  </head>
  <body class="min-h-screen text-slate-100">
    <div class="min-h-screen flex flex-col">
      <!-- ë©”ì¸ ì‘ì—… ì˜ì—­ -->
      <main id="app-shell" class="flex-1 flex flex-col">
        <!-- í—¤ë” -->
        <header
          class="border-b border-slate-800/50 glass sticky top-0 z-20 shadow-lg shadow-slate-900/50"
        >
          <div
            class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4"
          >
            <div>
              <h1 class="text-xl font-bold tracking-tight neon-text">
                ì‚¬ì´íŠ¸ë§µ ê¸°íš ë³´ë“œ
              </h1>
              <p class="text-xs text-slate-400 mt-1">
                í™ˆí˜ì´ì§€ ì œì‘ì„ ìœ„í•œ ë©”ë‰´/í˜ì´ì§€ êµ¬ì¡°, ìƒÂ·í•˜ìœ„ ê´€ê³„, ë³‘ë ¬/ì§ë ¬ êµ¬ì„±ì„ ì„¤ê³„í•˜ì„¸ìš”.
              </p>
            </div>
            <div class="flex items-center gap-2 text-xs text-slate-400">
              <span
                id="firebase-status"
                class="px-2 py-1 rounded-full border border-slate-700 bg-slate-900/60 hidden"
                title="Firebase ì—°ê²° ìƒíƒœ"
              ></span>
              <div class="flex gap-1">
                <button
                  id="undo-button"
                  class="px-2 py-1 rounded-lg border border-slate-700 bg-slate-900/80 hover:bg-slate-800 text-slate-200 text-[11px] transition opacity-40 cursor-not-allowed"
                  title="ì‹¤í–‰ ì·¨ì†Œ (Ctrl+Z)"
                  disabled
                >
                  â†¶ ë˜ëŒë¦¬ê¸°
                </button>
                <button
                  id="redo-button"
                  class="px-2 py-1 rounded-lg border border-slate-700 bg-slate-900/80 hover:bg-slate-800 text-slate-200 text-[11px] transition opacity-40 cursor-not-allowed"
                  title="ë‹¤ì‹œ ì‹¤í–‰ (Ctrl+Y)"
                  disabled
                >
                  â†· ë‹¤ì‹œì‹¤í–‰
                </button>
                <button
                  id="paste-button"
                  class="px-2 py-1 rounded-lg border border-emerald-600/70 bg-emerald-900/60 hover:bg-emerald-800 text-emerald-100 text-[11px] transition"
                  title="ë¶™ì—¬ë„£ê¸° (Ctrl+V)"
                >
                  ğŸ“‹ ë¶™ì—¬ë„£ê¸°
                </button>
              </div>
              <span
                class="px-2 py-1 rounded-full border border-slate-700 bg-slate-900/60"
                >Tailwind + JavaScript</span
              >
              <button
                id="export-json"
                class="px-3 py-1.5 rounded-lg border border-sky-500/70 bg-sky-500/10 hover:bg-sky-500/20 text-sky-200 text-[11px] transition-all hover:shadow-lg hover:shadow-sky-500/30 hover:scale-105"
              >
                ğŸ’¾ JSON ë‚´ë³´ë‚´ê¸°
              </button>
            </div>
          </div>
        </header>
        <div class="max-w-6xl mx-auto px-4 py-4 flex gap-4 flex-1">
          <!-- ì¢Œì¸¡: ì…ë ¥ ì‚¬ì´ë“œë°” -->
          <aside
            class="w-72 lg:w-80 shrink-0 glass rounded-2xl p-4 flex flex-col gap-4 sticky top-20 self-start shadow-xl shadow-slate-900/50 card-fade-in"
          >
            <!-- ì…ë ¥ í¼ -->
            <div class="flex flex-col gap-1.5">
              <div class="flex items-center justify-between gap-2">
                <h2 class="text-sm font-semibold text-slate-100">
                  í˜ì´ì§€ ì •ë³´ ì…ë ¥
                </h2>
              </div>
              <!-- í”„ë¡œì íŠ¸ ì„ íƒ -->
              <div class="flex flex-col gap-1 text-[11px] text-slate-400">
                <div class="flex items-center gap-2">
                  <label for="project-select" class="whitespace-nowrap"
                    >ì‘ì—… í”„ë¡œì íŠ¸</label
                  >
                  <select
                    id="project-select"
                    class="flex-1 rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1 text-[11px] focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60"
                  >
                    <!-- JSì—ì„œ ì±„ì›€ -->
                  </select>
                </div>
                <div class="flex items-center gap-2">
                  <div class="flex flex-wrap gap-1 flex-1">
                    <span
                      class="px-2 py-0.5 rounded-full border border-emerald-700/60 bg-emerald-950/40 text-emerald-300"
                    >
                      <span id="current-project-label">ê¸°ë³¸ í”„ë¡œì íŠ¸</span>
                    </span>
                  </div>
                  <button
                    type="button"
                    id="new-project-button"
                    class="px-2 py-1 rounded-lg border border-slate-700 bg-slate-900/80 hover:bg-slate-800 text-[11px] text-slate-200"
                  >
                    ìƒˆ í”„ë¡œì íŠ¸
                  </button>
                  <button
                    type="button"
                    id="delete-project-button"
                    class="px-2 py-1 rounded-lg border border-rose-600/70 bg-rose-900/60 hover:bg-rose-800 text-rose-100 text-[11px] transition"
                    title="í˜„ì¬ í”„ë¡œì íŠ¸ ì‚­ì œ"
                  >
                    ì‚­ì œ
                  </button>
                </div>
              </div>
            </div>

            <form
              id="page-form"
              class="flex flex-col gap-3 text-xs"
            >
              <input type="hidden" id="editing-id" />

              <!-- í˜ì´ì§€ ì œëª© -->
              <div>
                <label class="block mb-1 text-slate-300">í˜ì´ì§€ ì œëª©</label>
                <input
                  type="text"
                  id="title"
                  required
                  placeholder="ì˜ˆ) íšŒì‚¬ì†Œê°œ, ì„œë¹„ìŠ¤ ì†Œê°œ, ë¬¸ì˜í•˜ê¸°"
                  class="w-full rounded-lg border border-slate-700 bg-slate-900/60 px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60"
                />
              </div>

              <!-- URL ì£¼ì†Œ -->
              <div>
                <label class="block mb-1 text-slate-300">URL ì£¼ì†Œ</label>
                <div class="flex items-center gap-1">
                  <span
                    class="px-2 py-1 rounded-lg bg-slate-900/80 border border-slate-700 text-[11px] text-slate-400"
                    >/</span
                  >
                  <input
                    type="text"
                    id="url"
                    placeholder="about, service, contact ë“±"
                    class="w-full rounded-lg border border-slate-700 bg-slate-900/60 px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60"
                  />
                </div>
              </div>

              <!-- ìƒìœ„ ë©”ë‰´ -->
              <div>
                <label class="block mb-1 text-slate-300">ìƒìœ„ ë©”ë‰´</label>
                <select
                  id="parent-id"
                  class="w-full rounded-lg border border-slate-700 bg-slate-900/60 px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60"
                >
                  <option value="">(ìµœìƒìœ„ ë©”ë‰´)</option>
                </select>
                <p class="mt-1 text-[11px] text-slate-500">
                  ìƒìœ„ ë©”ë‰´ë¥¼ ì„ íƒí•˜ë©´ ì„ íƒí•œ ë©”ë‰´ì˜ í•˜ìœ„ í˜ì´ì§€ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.
                </p>
              </div>

              <!-- ìš”ì•½/ì„¤ëª… -->
              <div>
                <label class="block mb-1 text-slate-300">í˜ì´ì§€ ë‚´ìš© ìš”ì•½</label>
                <textarea
                  id="description"
                  rows="3"
                  placeholder="í˜ì´ì§€ì˜ ì£¼ìš” ëª©ì , í•µì‹¬ ì½˜í…ì¸ , íƒ€ê²Ÿ ì‚¬ìš©ì ë“±ì„ ê°„ë‹¨íˆ ì‘ì„±í•˜ì„¸ìš”."
                  class="w-full rounded-lg border border-slate-700 bg-slate-900/60 px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60"
                ></textarea>
              </div>

              <!-- ë²„íŠ¼ -->
              <div class="flex flex-col gap-2 mt-1">
                <div class="flex gap-2">
                  <button
                    type="submit"
                    id="add-button"
                    class="inline-flex items-center gap-1 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-medium px-3 py-1.5 text-xs transition btn-hover-glow"
                  >
                    âœ¨ í˜ì´ì§€ ì¶”ê°€
                  </button>
                  <button
                    type="button"
                    id="update-button"
                    class="inline-flex items-center gap-1 rounded-lg border border-amber-500/60 bg-amber-500/10 text-amber-200 px-3 py-1.5 text-xs transition opacity-40 cursor-not-allowed"
                  >
                    í˜ì´ì§€ ìˆ˜ì •
                  </button>
                  <button
                    type="button"
                    id="delete-button"
                    class="inline-flex items-center gap-1 rounded-lg border border-rose-600/70 bg-rose-900/60 hover:bg-rose-800 text-rose-100 px-3 py-1.5 text-xs transition opacity-40 cursor-not-allowed"
                  >
                    í˜ì´ì§€ ì‚­ì œ
                  </button>
                </div>
                <button
                  type="button"
                  id="save-project-button"
                  class="w-full inline-flex items-center justify-center gap-1 rounded-lg border border-sky-500/70 bg-sky-500/10 hover:bg-sky-500/20 text-sky-200 px-3 py-1.5 text-xs transition-all hover:shadow-lg hover:shadow-sky-500/30 hover:scale-105"
                >
                  ğŸ’¾ í”„ë¡œì íŠ¸ ì €ì¥
                </button>
              </div>
            </form>
          </aside>

          <!-- ìš°ì¸¡: ëª©ë¡ + êµ¬ì¡° ë¯¸ë¦¬ë³´ê¸° -->
          <section class="flex-1 flex flex-col gap-4">
            <!-- ì…ë ¥ëœ í˜ì´ì§€ ë¦¬ìŠ¤íŠ¸ -->
            <div class="glass rounded-2xl p-4 shadow-xl shadow-slate-900/50 card-fade-in">
              <div class="flex items-center justify-between mb-2">
                <div>
                  <h3 class="text-xs font-semibold text-slate-200">
                    í˜ì´ì§€ ëª©ë¡
                  </h3>
                  <p class="text-[10px] text-slate-500 mt-0.5">
                    ğŸ’¡ â†‘â†“ ë²„íŠ¼ìœ¼ë¡œ ê°™ì€ ë ˆë²¨ ë‚´ì—ì„œ ìˆœì„œ ë³€ê²½ ê°€ëŠ¥
                  </p>
                </div>
                <span
                  id="page-count"
                  class="text-[11px] text-slate-400 bg-slate-900/80 px-2 py-0.5 rounded-full border border-slate-700"
                  >0ê°œ í˜ì´ì§€</span
                >
              </div>
              <div
                class="max-h-64 lg:max-h-72 overflow-auto rounded-xl border border-slate-800/50 bg-gradient-to-b from-slate-950/60 to-slate-950/30 shadow-inner"
              >
                <table class="w-full text-[11px]">
                  <thead class="bg-gradient-to-r from-slate-900/90 to-slate-800/90 text-slate-300 sticky top-0 z-10 backdrop-blur-sm">
                    <tr>
                      <th class="px-3 py-2 text-left font-medium w-16">ë ˆë²¨</th>
                      <th class="px-3 py-2 text-left font-medium">ì œëª©</th>
                      <th class="px-3 py-2 text-left font-medium w-24">URL</th>
                      <th class="px-3 py-2 text-right font-medium w-32">ì•¡ì…˜</th>
                    </tr>
                  </thead>
                  <tbody id="page-table-body" class="divide-y divide-slate-800">
                    <tr>
                      <td
                        colspan="4"
                        class="px-3 py-6 text-center text-slate-500 text-xs"
                      >
                        ì•„ì§ ì¶”ê°€ëœ í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ì¢Œì¸¡ì—ì„œ í˜ì´ì§€ë¥¼
                        ì¶”ê°€í•˜ì„¸ìš”.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- êµ¬ì¡° ë¯¸ë¦¬ë³´ê¸° -->
            <section
              class="glass rounded-2xl p-4 flex flex-col gap-3 shadow-xl shadow-slate-900/50 card-fade-in"
            >
            <div class="flex items-center justify-between gap-2">
              <h2 class="text-sm font-semibold text-slate-100">
                ì‚¬ì´íŠ¸ë§µ êµ¬ì¡° ë¯¸ë¦¬ë³´ê¸°
              </h2>
              <div class="flex gap-2 text-[11px] text-slate-400">
                <button
                  id="expand-all"
                  class="px-2 py-0.5 rounded-lg border border-slate-700 hover:bg-slate-800"
                >
                  ì „ì²´ í¼ì¹˜ê¸°
                </button>
                <button
                  id="collapse-all"
                  class="px-2 py-0.5 rounded-lg border border-slate-700 hover:bg-slate-800"
                >
                  ì „ì²´ ì ‘ê¸°
                </button>
              </div>
            </div>

              <div
                class="text-[11px] text-slate-400 bg-slate-950/50 border border-dashed border-slate-700 rounded-xl px-3 py-2"
              >
                - ë°•ìŠ¤ ê°„ ì„¸ë¡œ ì¤„ê¸°ëŠ” ìƒÂ·í•˜ìœ„(ê³„ì¸µ) ê´€ê³„ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.<br />
                - ê°™ì€ ë ˆë²¨ì—ì„œ ì§ë ¬(ìˆœì°¨) ê·¸ë£¹ì€ ë²ˆí˜¸ë¡œ ì´ì–´ì§€ë©°, ë³‘ë ¬ ê·¸ë£¹ì€
                ê°€ë¡œë¡œ ë‚˜ë€íˆ ë°°ì¹˜ë©ë‹ˆë‹¤.<br />
                - ê° ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ í˜ì´ì§€ê°€ í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜ë©ë‹ˆë‹¤.
              </div>

              <div
                id="sitemap-container"
                class="flex-1 min-h-[260px] max-h-[420px] overflow-auto rounded-xl border border-slate-800/50 bg-gradient-to-br from-slate-950/80 via-slate-900/40 to-slate-950/60 px-3 py-3 shadow-inner"
              >
                <div
                  class="h-full flex items-center justify-center text-xs text-slate-500"
                >
                  ì¢Œì¸¡ì—ì„œ í˜ì´ì§€ë¥¼ ì¶”ê°€í•˜ë©´ ì‚¬ì´íŠ¸ë§µ êµ¬ì¡°ê°€ ìë™ìœ¼ë¡œ ê·¸ë ¤ì§‘ë‹ˆë‹¤.
                </div>
              </div>

            </section>
          </section>
        </div>
      </main>
    </div>

    <script>
      // ============================================
      // Firebase ì„¤ì • (ê°„ë‹¨ ë²„ì „)
      // ============================================
      // 1. https://console.firebase.google.com ì ‘ì† â†’ í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°
      // 2. ë¹Œë“œ > Realtime Database > ë°ì´í„°ë² ì´ìŠ¤ ë§Œë“¤ê¸° (í…ŒìŠ¤íŠ¸ ëª¨ë“œ)
      // 3. í†±ë‹ˆë°”í€´ ì•„ì´ì½˜ > í”„ë¡œì íŠ¸ ì„¤ì • > ì›¹ ì•± ì¶”ê°€ > ì„¤ì • ì •ë³´ ë³µì‚¬
      // 4. ì•„ë˜ firebaseConfigì— ë¶™ì—¬ë„£ê¸°
      //
      // ìì„¸í•œ ê°€ì´ë“œ: FIREBASE_SETUP.md íŒŒì¼ ì°¸ê³ 
      const firebaseConfig = {
        apiKey: "AIzaSyBtYMv7SLwLFybFaE81nfJ8kYMySGKd9cs",
        authDomain: "sitemap-9177c.firebaseapp.com",
        databaseURL: "https://sitemap-9177c-default-rtdb.firebaseio.com",
        projectId: "sitemap-9177c",
        storageBucket: "sitemap-9177c.firebasestorage.app",
        messagingSenderId: "806332670610",
        appId: "1:806332670610:web:5c2ab54730b40d53503c4b"
      };

      // Firebase ì´ˆê¸°í™”
      let database = null;
      let isFirebaseConfigured = false;
      
      try {
        if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY") {
          firebase.initializeApp(firebaseConfig);
          database = firebase.database();
          isFirebaseConfigured = true;
          console.log("Firebaseê°€ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
          console.warn("Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. localStorageë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.");
        }
      } catch (error) {
        console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
        console.warn("localStorageë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.");
      }

      // Firebase ë°ì´í„°ë² ì´ìŠ¤ ê²½ë¡œ
      const DB_PATH = "sitemapProjects";

      // í”„ë¡œì íŠ¸ & í˜ì´ì§€ ë°ì´í„° ì €ì¥ìš© ë©”ëª¨ë¦¬
      const projects = [];
      let currentProjectId = null;
      let pages = []; // í•­ìƒ í˜„ì¬ í”„ë¡œì íŠ¸ì˜ pages ë°°ì—´ì„ ê°€ë¦¬í‚¤ë„ë¡ ì‚¬ìš©
      let firebaseListener = null; // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì°¸ì¡°

      // Undo/Redo íˆìŠ¤í† ë¦¬ ê´€ë¦¬
      const history = {
        past: [],
        future: [],
        maxSize: 50,
        isRestoring: false // ë³µì› ì¤‘ì¸ì§€ ì—¬ë¶€ (ìë™ ì €ì¥ ë°©ì§€)
      };

      // í˜ì´ì§€ ë³µì‚¬ ê´€ë¦¬
      let copiedPage = null;

      const appShell = document.getElementById("app-shell");

      const form = document.getElementById("page-form");
      const editingIdInput = document.getElementById("editing-id");
      const addButton = document.getElementById("add-button");
      const updateButton = document.getElementById("update-button");
      const deleteButton = document.getElementById("delete-button");
      const saveProjectButton = document.getElementById("save-project-button");
      const projectSelect = document.getElementById("project-select");
      const newProjectButton = document.getElementById("new-project-button");
      const deleteProjectButton = document.getElementById("delete-project-button");
      const currentProjectLabel = document.getElementById(
        "current-project-label"
      );
      const parentSelect = document.getElementById("parent-id");
      const pageTableBody = document.getElementById("page-table-body");
      const pageCountBadge = document.getElementById("page-count");
      const sitemapContainer = document.getElementById("sitemap-container");
      const expandAllBtn = document.getElementById("expand-all");
      const collapseAllBtn = document.getElementById("collapse-all");
      const exportJsonBtn = document.getElementById("export-json");
      const firebaseStatus = document.getElementById("firebase-status");

      // ê°„ë‹¨í•œ ID ìƒì„±
      const createId = () =>
        "p_" + Math.random().toString(36).substring(2, 9);

      // ============================================
      // Undo/Redo ê¸°ëŠ¥
      // ============================================
      function saveStateToHistory() {
        if (history.isRestoring) return; // ë³µì› ì¤‘ì—ëŠ” íˆìŠ¤í† ë¦¬ ì €ì¥ ì•ˆ í•¨

        const state = {
          projects: JSON.parse(JSON.stringify(projects)),
          currentProjectId: currentProjectId
        };

        history.past.push(state);
        if (history.past.length > history.maxSize) {
          history.past.shift();
        }
        history.future = []; // ìƒˆ ì•¡ì…˜ì´ ë°œìƒí•˜ë©´ redo ìŠ¤íƒ ì´ˆê¸°í™”
        updateUndoRedoButtons();
      }

      function undo() {
        if (history.past.length === 0) return;

        history.isRestoring = true;

        // í˜„ì¬ ìƒíƒœë¥¼ futureì— ì €ì¥
        const currentState = {
          projects: JSON.parse(JSON.stringify(projects)),
          currentProjectId: currentProjectId
        };
        history.future.push(currentState);

        // ì´ì „ ìƒíƒœ ë³µì›
        const previousState = history.past.pop();
        restoreState(previousState);

        history.isRestoring = false;
        updateUndoRedoButtons();
      }

      function redo() {
        if (history.future.length === 0) return;

        history.isRestoring = true;

        // í˜„ì¬ ìƒíƒœë¥¼ pastì— ì €ì¥
        const currentState = {
          projects: JSON.parse(JSON.stringify(projects)),
          currentProjectId: currentProjectId
        };
        history.past.push(currentState);

        // ë‹¤ìŒ ìƒíƒœ ë³µì›
        const nextState = history.future.pop();
        restoreState(nextState);

        history.isRestoring = false;
        updateUndoRedoButtons();
      }

      function restoreState(state) {
        // í”„ë¡œì íŠ¸ ë°ì´í„° ë³µì›
        projects.length = 0;
        state.projects.forEach(p => projects.push(p));

        // í˜„ì¬ í”„ë¡œì íŠ¸ ë³µì›
        if (state.currentProjectId) {
          currentProjectId = state.currentProjectId;
          const current = getCurrentProject();
          if (current) {
            pages = current.pages;
          }
        }

        // UI ê°±ì‹ 
        refreshProjectSelect();
        refreshParentOptions();
        renderTable();
        renderSitemap();
        resetForm();

        // ìë™ ì €ì¥
        autoSave();
      }

      function updateUndoRedoButtons() {
        const undoBtn = document.getElementById('undo-button');
        const redoBtn = document.getElementById('redo-button');

        if (undoBtn) {
          undoBtn.disabled = history.past.length === 0;
          if (history.past.length === 0) {
            undoBtn.classList.add('opacity-40', 'cursor-not-allowed');
          } else {
            undoBtn.classList.remove('opacity-40', 'cursor-not-allowed');
          }
        }

        if (redoBtn) {
          redoBtn.disabled = history.future.length === 0;
          if (history.future.length === 0) {
            redoBtn.classList.add('opacity-40', 'cursor-not-allowed');
          } else {
            redoBtn.classList.remove('opacity-40', 'cursor-not-allowed');
          }
        }
      }

      // ============================================
      // í˜ì´ì§€ ë³µì‚¬/ë¶™ì—¬ë„£ê¸° ê¸°ëŠ¥
      // ============================================
      function copyPage(id) {
        const page = pages.find(p => p.id === id);
        if (!page) return;

        copiedPage = JSON.parse(JSON.stringify(page));

        // ë³µì‚¬ ì„±ê³µ í”¼ë“œë°±
        const copyBtn = document.querySelector(`button[data-copy-id="${id}"]`);
        if (copyBtn) {
          const originalText = copyBtn.innerHTML;
          copyBtn.innerHTML = 'âœ“';
          copyBtn.classList.add('text-emerald-300');
          setTimeout(() => {
            copyBtn.innerHTML = originalText;
            copyBtn.classList.remove('text-emerald-300');
          }, 1000);
        }
      }

      function pastePage() {
        if (!copiedPage) {
          alert("ë³µì‚¬ëœ í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í˜ì´ì§€ë¥¼ ë³µì‚¬í•˜ì„¸ìš”.");
          return;
        }

        // íˆìŠ¤í† ë¦¬ì— í˜„ì¬ ìƒíƒœ ì €ì¥
        saveStateToHistory();

        // ìƒˆ í˜ì´ì§€ ìƒì„± (ë³µì‚¬ë³¸)
        const newPage = {
          ...copiedPage,
          id: createId(),
          title: copiedPage.title + " (ë³µì‚¬)",
          order: pages.length,
          createdAt: new Date().toISOString()
        };

        pages.push(newPage);

        refreshParentOptions();
        renderTable();
        renderSitemap();

        // ìë™ ì €ì¥
        autoSave();

        // ì„±ê³µ ë©”ì‹œì§€
        alert(`"${copiedPage.title}" í˜ì´ì§€ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }

      // ============================================
      // ìœ„/ì•„ë˜ ì´ë™ ê¸°ëŠ¥
      // ============================================
      function movePageUp(pageId) {
        const page = pages.find(p => p.id === pageId);
        if (!page) return;

        // íˆìŠ¤í† ë¦¬ì— í˜„ì¬ ìƒíƒœ ì €ì¥
        saveStateToHistory();

        // ê°™ì€ ë¶€ëª¨ë¥¼ ê°€ì§„ í˜•ì œ í˜ì´ì§€ë“¤ ì°¾ê¸°
        const siblings = pages.filter(p => (p.parentId || null) === (page.parentId || null));

        // order í•„ë“œ ì´ˆê¸°í™”
        siblings.forEach((p, idx) => {
          if (typeof p.order !== 'number') {
            p.order = idx;
          }
        });

        // order ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
        siblings.sort((a, b) => a.order - b.order);

        // í˜„ì¬ í˜ì´ì§€ì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
        const currentIndex = siblings.findIndex(p => p.id === pageId);

        if (currentIndex <= 0) {
          // ì´ë¯¸ ë§¨ ìœ„
          return;
        }

        // ìœ„ í˜ì´ì§€ì™€ order êµí™˜
        const temp = siblings[currentIndex].order;
        siblings[currentIndex].order = siblings[currentIndex - 1].order;
        siblings[currentIndex - 1].order = temp;

        // order ì¬ì •ë ¬
        siblings.sort((a, b) => a.order - b.order);
        siblings.forEach((p, idx) => {
          p.order = idx;
        });

        // ë Œë”ë§ ë° ì €ì¥
        renderTable();
        renderSitemap();
        autoSave();
      }

      function movePageDown(pageId) {
        const page = pages.find(p => p.id === pageId);
        if (!page) return;

        // íˆìŠ¤í† ë¦¬ì— í˜„ì¬ ìƒíƒœ ì €ì¥
        saveStateToHistory();

        // ê°™ì€ ë¶€ëª¨ë¥¼ ê°€ì§„ í˜•ì œ í˜ì´ì§€ë“¤ ì°¾ê¸°
        const siblings = pages.filter(p => (p.parentId || null) === (page.parentId || null));

        // order í•„ë“œ ì´ˆê¸°í™”
        siblings.forEach((p, idx) => {
          if (typeof p.order !== 'number') {
            p.order = idx;
          }
        });

        // order ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
        siblings.sort((a, b) => a.order - b.order);

        // í˜„ì¬ í˜ì´ì§€ì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
        const currentIndex = siblings.findIndex(p => p.id === pageId);

        if (currentIndex < 0 || currentIndex >= siblings.length - 1) {
          // ì´ë¯¸ ë§¨ ì•„ë˜
          return;
        }

        // ì•„ë˜ í˜ì´ì§€ì™€ order êµí™˜
        const temp = siblings[currentIndex].order;
        siblings[currentIndex].order = siblings[currentIndex + 1].order;
        siblings[currentIndex + 1].order = temp;

        // order ì¬ì •ë ¬
        siblings.sort((a, b) => a.order - b.order);
        siblings.forEach((p, idx) => {
          p.order = idx;
        });

        // ë Œë”ë§ ë° ì €ì¥
        renderTable();
        renderSitemap();
        autoSave();
      }

      // í˜„ì¬ í”„ë¡œì íŠ¸ ê°€ì ¸ì˜¤ê¸°
      function getCurrentProject() {
        return projects.find((p) => p.id === currentProjectId) || null;
      }

      // í”„ë¡œì íŠ¸ ì„ íƒ UI ê°±ì‹ 
      function refreshProjectSelect() {
        projectSelect.innerHTML = "";
        projects.forEach((p) => {
          const option = document.createElement("option");
          option.value = p.id;
          const count = (p.pages || []).length;
          option.textContent = `${p.name}${
            count ? ` (${count} í˜ì´ì§€)` : ""
          }`;
          projectSelect.appendChild(option);
        });
        if (currentProjectId) {
          projectSelect.value = currentProjectId;
        }
        const current = getCurrentProject();
        if (current) {
          currentProjectLabel.textContent = current.name;
        }
      }

      // í”„ë¡œì íŠ¸ ìƒì„±
      function createProject(name) {
        const id = "proj_" + Math.random().toString(36).substring(2, 9);
        const project = { id, name, pages: [] };
        projects.push(project);
        return project;
      }

      // í”„ë¡œì íŠ¸ ì „í™˜
      function setCurrentProject(id) {
        const project = projects.find((p) => p.id === id);
        if (!project) return;
        currentProjectId = id;
        pages = project.pages;

        // order í•„ë“œ ì´ˆê¸°í™” (ì—†ëŠ” í˜ì´ì§€ë“¤ì—ê²Œ ì¶”ê°€)
        initializePageOrder();

        resetForm();
        refreshProjectSelect();
        refreshParentOptions();
        renderTable();
        renderSitemap();

        // í”„ë¡œì íŠ¸ ì „í™˜ ì‹œ ìë™ ì €ì¥ (Firebase ì‚¬ìš© ì‹œ)
        if (isFirebaseConfigured) {
          autoSave();
        }
      }

      // í˜ì´ì§€ order í•„ë“œ ì´ˆê¸°í™”
      function initializePageOrder() {
        // ë¶€ëª¨ë³„ë¡œ ê·¸ë£¹í™”
        const pagesByParent = {};
        pages.forEach(p => {
          const parentKey = p.parentId || 'root';
          if (!pagesByParent[parentKey]) {
            pagesByParent[parentKey] = [];
          }
          pagesByParent[parentKey].push(p);
        });

        // ê° ê·¸ë£¹ë³„ë¡œ order ë¶€ì—¬
        Object.values(pagesByParent).forEach(group => {
          group.forEach((p, idx) => {
            if (typeof p.order !== 'number') {
              p.order = idx;
            }
          });
        });
      }

      // í”„ë¡œì íŠ¸ ì‚­ì œ
      function deleteProject() {
        const current = getCurrentProject();
        if (!current) {
          alert("ì‚­ì œí•  í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // ìµœì†Œ 1ê°œ í”„ë¡œì íŠ¸ëŠ” ìœ ì§€
        if (projects.length <= 1) {
          alert("ìµœì†Œ 1ê°œì˜ í”„ë¡œì íŠ¸ëŠ” ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.");
          return;
        }

        const projectName = current.name;
        const pageCount = (current.pages || []).length;
        
        if (!confirm(`"${projectName}" í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(í˜ì´ì§€ ${pageCount}ê°œê°€ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.)`)) {
          return;
        }

        // í”„ë¡œì íŠ¸ ì‚­ì œ
        const index = projects.findIndex((p) => p.id === currentProjectId);
        if (index >= 0) {
          projects.splice(index, 1);
        }

        // ë‹¤ë¥¸ í”„ë¡œì íŠ¸ë¡œ ì „í™˜ (ì²« ë²ˆì§¸ í”„ë¡œì íŠ¸)
        if (projects.length > 0) {
          setCurrentProject(projects[0].id);
        } else {
          // í”„ë¡œì íŠ¸ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ í”„ë¡œì íŠ¸ ìƒì„±
          const defaultProject = createProject("ê¸°ë³¸ í”„ë¡œì íŠ¸");
          setCurrentProject(defaultProject.id);
        }

        // Firebase ë˜ëŠ” localStorageì—ì„œë„ ì‚­ì œëœ í”„ë¡œì íŠ¸ ì œê±°
        saveProject();
      }

      // í”„ë¡œì íŠ¸ ì €ì¥ (Firebase ë˜ëŠ” localStorage)
      async function saveProject() {
        const current = getCurrentProject();
        if (!current) {
          alert("ì €ì¥í•  í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        try {
          // ëª¨ë“  í”„ë¡œì íŠ¸ ì €ì¥
          const savedData = {
            projects: projects,
            currentProjectId: currentProjectId,
            savedAt: new Date().toISOString()
          };

          if (isFirebaseConfigured && database) {
            // Firebaseì— ì €ì¥
            await database.ref(DB_PATH).set(savedData);
            console.log("Firebaseì— ì €ì¥ ì™„ë£Œ");
          } else {
            // localStorageì— ì €ì¥ (ë°±ì—…)
            localStorage.setItem("sitemapProjects", JSON.stringify(savedData));
          }
          
          // í”„ë¡œì íŠ¸ ì„ íƒ ëª©ë¡ ì—…ë°ì´íŠ¸
          refreshProjectSelect();
          
          // ì„±ê³µ ë©”ì‹œì§€
          const originalText = saveProjectButton.textContent;
          saveProjectButton.textContent = isFirebaseConfigured ? "ì €ì¥ ì™„ë£Œ! (ì‹¤ì‹œê°„ ë™ê¸°í™”)" : "ì €ì¥ ì™„ë£Œ!";
          saveProjectButton.classList.add("bg-emerald-500/20", "border-emerald-500/70", "text-emerald-200");
          saveProjectButton.classList.remove("bg-sky-500/10", "border-sky-500/70", "text-sky-200");
          
          setTimeout(() => {
            saveProjectButton.textContent = originalText;
            saveProjectButton.classList.remove("bg-emerald-500/20", "border-emerald-500/70", "text-emerald-200");
            saveProjectButton.classList.add("bg-sky-500/10", "border-sky-500/70", "text-sky-200");
          }, 2000);
        } catch (error) {
          console.error("ì €ì¥ ì˜¤ë¥˜:", error);
          const errorMessage = error.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";
          let userMessage = "í”„ë¡œì íŠ¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + errorMessage;
          
          // ê¶Œí•œ ì˜¤ë¥˜ì¸ ê²½ìš° ì•ˆë‚´ ë©”ì‹œì§€ ì¶”ê°€
          if (errorMessage.includes("PERMISSION_DENIED") || errorMessage.includes("Permission denied")) {
            userMessage += "\n\ní•´ê²° ë°©ë²•:\n1. Firebase Console â†’ Realtime Database â†’ ê·œì¹™\n2. FIREBASE_SECURITY_RULES.md íŒŒì¼ ì°¸ê³ ";
          }
          
          alert(userMessage);
        }
      }

      // ìë™ ì €ì¥ (í˜ì´ì§€ ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ ì‹œ)
      async function autoSave() {
        if (isFirebaseConfigured && database) {
          try {
            const savedData = {
              projects: projects,
              currentProjectId: currentProjectId,
              savedAt: new Date().toISOString()
            };
            await database.ref(DB_PATH).set(savedData);
            console.log("ìë™ ì €ì¥ ì™„ë£Œ");
          } catch (error) {
            console.error("ìë™ ì €ì¥ ì˜¤ë¥˜:", error);
            // ìë™ ì €ì¥ ì‹¤íŒ¨ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ì‚¬ìš©ìì—ê²Œ ì•Œë¦¬ì§€ ì•ŠìŒ)
            // ìˆ˜ë™ ì €ì¥ ë²„íŠ¼ì„ í†µí•´ ì €ì¥í•  ìˆ˜ ìˆìŒ
          }
        } else {
          // Firebaseê°€ ì—†ìœ¼ë©´ localStorageì— ì €ì¥
          try {
            const savedData = {
              projects: projects,
              currentProjectId: currentProjectId,
              savedAt: new Date().toISOString()
            };
            localStorage.setItem("sitemapProjects", JSON.stringify(savedData));
            console.log("localStorageì— ìë™ ì €ì¥ ì™„ë£Œ");
          } catch (error) {
            console.error("localStorage ìë™ ì €ì¥ ì˜¤ë¥˜:", error);
          }
        }
      }

      // í”„ë¡œì íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° (Firebase ìš°ì„ , ì—†ìœ¼ë©´ localStorage)
      async function loadProjects() {
        try {
          let data = null;

          if (isFirebaseConfigured && database) {
            // Firebaseì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° (ìš°ì„ )
            try {
              const snapshot = await database.ref(DB_PATH).once('value');
              if (snapshot.exists()) {
                data = snapshot.val();
                console.log("Firebaseì—ì„œ í”„ë¡œì íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ");
              } else {
                console.log("Firebaseì— ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                // Firebaseì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ localStorage í™•ì¸
                const savedData = localStorage.getItem("sitemapProjects");
                if (savedData) {
                  data = JSON.parse(savedData);
                  console.log("localStorageì—ì„œ í”„ë¡œì íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ");
                  // localStorage ë°ì´í„°ë¥¼ Firebaseì— ë™ê¸°í™”
                  await autoSave();
                }
              }
            } catch (firebaseError) {
              console.error("Firebase ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", firebaseError);
              // Firebase ì˜¤ë¥˜ ì‹œ localStorage ì‚¬ìš©
              const savedData = localStorage.getItem("sitemapProjects");
              if (savedData) {
                data = JSON.parse(savedData);
                console.log("Firebase ì˜¤ë¥˜ë¡œ localStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°");
              }
            }
          } else {
            // Firebaseê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìœ¼ë©´ localStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
            const savedData = localStorage.getItem("sitemapProjects");
            if (savedData) {
              data = JSON.parse(savedData);
            }
          }

          if (!data) return false;

          if (data.projects && Array.isArray(data.projects)) {
            // ê¸°ì¡´ í”„ë¡œì íŠ¸ ë°°ì—´ì— ì €ì¥ëœ í”„ë¡œì íŠ¸ ì¶”ê°€
            data.projects.forEach(savedProject => {
              // ì¤‘ë³µ ID ì²´í¬
              const exists = projects.find(p => p.id === savedProject.id);
              if (!exists) {
                projects.push(savedProject);
              } else {
                // ê¸°ì¡´ í”„ë¡œì íŠ¸ ì—…ë°ì´íŠ¸ (í˜ì´ì§€ ë°ì´í„°ë§Œ)
                const existing = projects.find(p => p.id === savedProject.id);
                if (existing) {
                  existing.pages = savedProject.pages || [];
                  existing.name = savedProject.name || existing.name;
                }
              }
            });

            // í˜„ì¬ í”„ë¡œì íŠ¸ ë³µì›
            if (data.currentProjectId) {
              const restored = projects.find(p => p.id === data.currentProjectId);
              if (restored) {
                setCurrentProject(data.currentProjectId);
                return true;
              }
            }
          }
          return false;
        } catch (error) {
          console.error("í”„ë¡œì íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
          return false;
        }
      }

      // Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      function setupRealtimeSync() {
        if (!isFirebaseConfigured || !database) {
          return;
        }

        // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°
        if (firebaseListener) {
          database.ref(DB_PATH).off('value', firebaseListener);
        }

        // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        firebaseListener = database.ref(DB_PATH).on('value', (snapshot) => {
          if (!snapshot.exists()) return;

          const data = snapshot.val();
          if (!data || !data.projects) return;

          // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ í˜ì´ì§€ê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ (ì¶©ëŒ ë°©ì§€)
          const isEditing = editingIdInput.value !== "";

          // í”„ë¡œì íŠ¸ ë°ì´í„° ë™ê¸°í™”
          const remoteProjects = data.projects || [];
          let hasChanges = false;

          remoteProjects.forEach(remoteProject => {
            const localProject = projects.find(p => p.id === remoteProject.id);
            
            if (!localProject) {
              // ìƒˆ í”„ë¡œì íŠ¸ ì¶”ê°€
              projects.push(remoteProject);
              hasChanges = true;
            } else {
              // í”„ë¡œì íŠ¸ ì—…ë°ì´íŠ¸ (í¸ì§‘ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ)
              if (!isEditing && JSON.stringify(localProject.pages) !== JSON.stringify(remoteProject.pages)) {
                localProject.pages = remoteProject.pages || [];
                localProject.name = remoteProject.name || localProject.name;
                hasChanges = true;
              }
            }
          });

          // í”„ë¡œì íŠ¸ ëª©ë¡ì´ ë³€ê²½ë˜ì—ˆìœ¼ë©´ UI ì—…ë°ì´íŠ¸
          if (hasChanges && !isEditing) {
            // í”„ë¡œì íŠ¸ ì„ íƒ ëª©ë¡ ê°±ì‹ 
            refreshProjectSelect();
            
            const current = getCurrentProject();
            if (current) {
              pages = current.pages;
              refreshParentOptions();
              renderTable();
              renderSitemap();
            }
          }

          // í˜„ì¬ í”„ë¡œì íŠ¸ ID ë™ê¸°í™” (ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ì—ì„œ í”„ë¡œì íŠ¸ ì „í™˜ ì‹œ)
          if (data.currentProjectId && data.currentProjectId !== currentProjectId && !isEditing) {
            const targetProject = projects.find(p => p.id === data.currentProjectId);
            if (targetProject) {
              // setCurrentProjectë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šê³  ì§ì ‘ ì „í™˜ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
              currentProjectId = data.currentProjectId;
              pages = targetProject.pages;
              refreshProjectSelect();
              refreshParentOptions();
              renderTable();
              renderSitemap();
              resetForm();
            }
          }
        }, (error) => {
          console.error("Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” ì˜¤ë¥˜:", error);
        });

        console.log("Firebase ì‹¤ì‹œê°„ ë™ê¸°í™”ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      // í¼ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
      function getFormData() {
        const title = document.getElementById("title").value.trim();
        const url = document.getElementById("url").value.trim();
        const parentId = parentSelect.value || null;
        const description =
          document.getElementById("description").value.trim();

        return {
          title,
          url,
          parentId,
          description,
        };
      }

      // í¼ ì±„ìš°ê¸° (í¸ì§‘ìš©)
      function fillForm(page) {
        document.getElementById("title").value = page.title;
        document.getElementById("url").value = page.url;
        parentSelect.value = page.parentId || "";
        document.getElementById("description").value = page.description || "";
      }

      // í¼ ì´ˆê¸°í™”
      function resetForm() {
        form.reset();
        editingIdInput.value = "";
        // ì¶”ê°€ ë²„íŠ¼ ê¸°ë³¸ ìƒíƒœ, ìˆ˜ì • ë²„íŠ¼ ë¹„í™œì„±í™”
        addButton.disabled = false;
        addButton.classList.remove("opacity-40", "cursor-not-allowed");
        addButton.classList.add("bg-emerald-500", "hover:bg-emerald-400");

        updateButton.disabled = true;
        updateButton.classList.add("opacity-40", "cursor-not-allowed");

        deleteButton.disabled = true;
        deleteButton.classList.add("opacity-40", "cursor-not-allowed");
      }

      // ìƒìœ„ ë©”ë‰´ ì˜µì…˜ ê°±ì‹ 
      function refreshParentOptions() {
        const currentEditingId = editingIdInput.value || null;
        const previous = parentSelect.value;
        parentSelect.innerHTML = '<option value="">(ìµœìƒìœ„ ë©”ë‰´)</option>';

        pages.forEach((p) => {
          // ìê¸° ìì‹ ì€ ìƒìœ„ ë©”ë‰´ë¡œ ì„ íƒ ë¶ˆê°€
          if (p.id === currentEditingId) return;
          const depth = getDepth(p.id);
          const indent = "â”€".repeat(depth);
          const option = document.createElement("option");
          option.value = p.id;
          option.textContent =
            (indent ? indent + " " : "") +
            (p.title || "(ì œëª© ì—†ìŒ)") +
            (p.code ? ` [${p.code}]` : "");
          parentSelect.appendChild(option);
        });

        // í¸ì§‘ ì¤‘ì´ë˜ ê°’ ìœ ì§€ ì‹œë„
        if (previous && previous !== currentEditingId) {
          parentSelect.value = previous;
        }
      }

      // ê¹Šì´ ê³„ì‚° (ë£¨íŠ¸ = 0)
      function getDepth(id) {
        let depth = 0;
        let current = pages.find((p) => p.id === id);
        while (current && current.parentId) {
          depth++;
          current = pages.find((p) => p.id === current.parentId);
        }
        return depth;
      }

      // íŠ¸ë¦¬ êµ¬ì¡°ìš© ë…¸ë“œ êµ¬ì„±
      function buildTree() {
        const map = {};
        const roots = [];

        pages.forEach((p) => {
          map[p.id] = { ...p, children: [] };
        });

        Object.values(map).forEach((node) => {
          if (node.parentId && map[node.parentId]) {
            map[node.parentId].children.push(node);
          } else {
            roots.push(node);
          }
        });

        // ê°™ì€ ë¶€ëª¨ ì•„ë˜ì—ì„œ order í•„ë“œ ê¸°ì¤€ ì •ë ¬ (ì—†ìœ¼ë©´ order ì´ˆê¸°í™” í›„ ì •ë ¬)
        function sortChildren(nodes) {
          // order í•„ë“œê°€ ì—†ëŠ” ë…¸ë“œë“¤ì—ê²Œ ì¸ë±ìŠ¤ ë¶€ì—¬
          nodes.forEach((node, idx) => {
            if (typeof node.order !== 'number') {
              node.order = idx;
            }
          });

          // order ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
          nodes.sort((a, b) => a.order - b.order);

          // ìì‹ë“¤ë„ ì¬ê·€ì ìœ¼ë¡œ ì •ë ¬
          nodes.forEach((n) => sortChildren(n.children));
        }

        sortChildren(roots);

        // ê° ë£¨íŠ¸ì˜ 1ë ˆë²¨ ìì‹ë¶€í„° ë¸Œëœì¹˜ ìƒ‰ìƒ ì¸ë±ìŠ¤ë¥¼ ë¶€ì—¬
        const assignBranchColor = (node, branchIndex) => {
          node.branchColorIndex = branchIndex;
          node.children.forEach((child) =>
            assignBranchColor(child, branchIndex)
          );
        };

        roots.forEach((root) => {
          root.children.forEach((child, idx) => {
            const branchIndex = idx; // ìƒ‰ìƒ ë°°ì—´ ê¸¸ì´ì— ë”°ë¼ ë‚˜ì¤‘ì— ëª¨ë“ˆë¡œ ì²˜ë¦¬
            assignBranchColor(child, branchIndex);
          });
        });

        return roots;
      }

      // í…Œì´ë¸” ë Œë”ë§
      function renderTable() {
        pageTableBody.innerHTML = "";
        if (!pages.length) {
          pageTableBody.innerHTML =
            '<tr><td colspan="4" class="px-3 py-6 text-center text-slate-500 text-xs">ì•„ì§ ì¶”ê°€ëœ í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒë‹¨ í¼ì„ ì´ìš©í•´ í˜ì´ì§€ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</td></tr>';
          pageCountBadge.textContent = "0ê°œ í˜ì´ì§€";
          return;
        }

        const tree = buildTree();
        const rows = [];

        function walk(node, level) {
          rows.push({ node, level });
          node.children.forEach((child) => walk(child, level + 1));
        }
        tree.forEach((root) => walk(root, 0));

        rows.forEach(({ node, level }) => {
          const tr = document.createElement("tr");
          tr.className =
            "hover:bg-slate-900/70 transition border-b border-slate-900/40 last:border-b-0";
          tr.dataset.pageId = node.id;

          const depthBadge =
            level === 0
              ? '<span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-emerald-500/15 text-emerald-300 border border-emerald-500/40 text-[10px]">0</span>'
              : `<span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-slate-800 text-slate-200 border border-slate-600 text-[10px]">${level}</span>`;

          const urlDisplay = node.url
            ? "/" + node.url.replace(/^\/+/, "")
            : "-";

          // í…Œì´ë¸” ì…€ ìƒì„±
          const levelCell = document.createElement('td');
          levelCell.className = 'px-3 py-1.5 align-top';
          levelCell.innerHTML = depthBadge;

          const titleCell = document.createElement('td');
          titleCell.className = 'px-3 py-1.5 align-top';
          titleCell.innerHTML = `
            <div class="flex flex-col">
              <span class="text-[11px] text-slate-100 font-medium">${node.title || "(ì œëª© ì—†ìŒ)"}</span>
              <span class="text-[10px] text-slate-500">
                ${(node.parentId
                  ? "í•˜ìœ„ Â· " +
                    (pages.find((p) => p.id === node.parentId)?.title ||
                      "ìƒìœ„ ë©”ë‰´")
                  : "ìµœìƒìœ„ ë©”ë‰´")}
              </span>
            </div>
          `;

          const urlCell = document.createElement('td');
          urlCell.className = 'px-3 py-1.5 align-top';
          urlCell.innerHTML = `<span class="font-mono text-[10px] text-slate-200">${urlDisplay}</span>`;

          const actionCell = document.createElement('td');
          actionCell.className = 'px-3 py-1.5 align-top text-right';

          // ìœ„ë¡œ ì´ë™ ë²„íŠ¼
          const upBtn = document.createElement('button');
          upBtn.className = 'text-[12px] text-violet-400 hover:text-violet-300 mr-1 font-bold';
          upBtn.innerHTML = 'â†‘';
          upBtn.title = 'ìœ„ë¡œ ì´ë™';
          upBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            movePageUp(node.id);
          });

          // ì•„ë˜ë¡œ ì´ë™ ë²„íŠ¼
          const downBtn = document.createElement('button');
          downBtn.className = 'text-[12px] text-violet-400 hover:text-violet-300 mr-2 font-bold';
          downBtn.innerHTML = 'â†“';
          downBtn.title = 'ì•„ë˜ë¡œ ì´ë™';
          downBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            movePageDown(node.id);
          });

          // ë³µì‚¬ ë²„íŠ¼
          const copyBtn = document.createElement('button');
          copyBtn.className = 'copy-page text-[10px] text-emerald-300 hover:text-emerald-200 mr-1';
          copyBtn.textContent = 'ë³µì‚¬';
          copyBtn.dataset.copyId = node.id;
          copyBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            copyPage(node.id);
          });

          // í¸ì§‘ ë²„íŠ¼
          const editBtn = document.createElement('button');
          editBtn.className = 'edit-page text-[10px] text-sky-300 hover:text-sky-200 mr-1';
          editBtn.textContent = 'í¸ì§‘';
          editBtn.dataset.id = node.id;
          editBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            enterEditMode(node.id);
          });

          // ì‚­ì œ ë²„íŠ¼
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-page text-[10px] text-rose-300 hover:text-rose-200';
          deleteBtn.textContent = 'ì‚­ì œ';
          deleteBtn.dataset.id = node.id;
          deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            deletePage(node.id);
          });

          actionCell.appendChild(upBtn);
          actionCell.appendChild(downBtn);
          actionCell.appendChild(copyBtn);
          actionCell.appendChild(editBtn);
          actionCell.appendChild(deleteBtn);

          tr.appendChild(levelCell);
          tr.appendChild(titleCell);
          tr.appendChild(urlCell);
          tr.appendChild(actionCell);

          pageTableBody.appendChild(tr);
        });

        pageCountBadge.textContent = `${pages.length}ê°œ í˜ì´ì§€`;
      }

      // ì‚¬ì´íŠ¸ë§µ íŠ¸ë¦¬ ë Œë”ë§ (ë¶€ëª¨/ìì‹ ì‹œê° êµ¬ë¶„ í¬í•¨)
      function renderSitemap() {
        sitemapContainer.innerHTML = "";
        if (!pages.length) {
          sitemapContainer.innerHTML =
            '<div class="h-full flex items-center justify-center text-xs text-slate-500">ì¢Œì¸¡ì—ì„œ í˜ì´ì§€ë¥¼ ì¶”ê°€í•˜ë©´ ì‚¬ì´íŠ¸ë§µ êµ¬ì¡°ê°€ ìë™ìœ¼ë¡œ ê·¸ë ¤ì§‘ë‹ˆë‹¤.</div>';
          return;
        }

        const tree = buildTree();

        const rootContainer = document.createElement("div");
        rootContainer.className =
          "flex flex-row flex-wrap gap-4 text-[11px] text-slate-100 items-flex-start";

        // ë¸Œëœì¹˜ë³„ ìƒ‰ìƒ ì •ì˜: 1ë ˆë²¨ ë¶€ëª¨ë§ˆë‹¤ ë‹¤ë¥¸ ê³„ì—´, ìì‹ì€ ì±„ë„ë§Œ ë‚®ì¶¤
        const branchStyles = [
          {
            strong: "border-emerald-400 bg-emerald-500/18",
            soft: "border-emerald-300/80 bg-emerald-500/6",
            badgeParent: "bg-emerald-500 text-emerald-950 border-emerald-300",
            badgeChild:
              "bg-emerald-950/80 text-emerald-200 border-emerald-400/80",
          },
          {
            strong: "border-sky-400 bg-sky-500/18",
            soft: "border-sky-300/80 bg-sky-500/6",
            badgeParent: "bg-sky-500 text-sky-950 border-sky-300",
            badgeChild: "bg-sky-950/80 text-sky-200 border-sky-400/80",
          },
          {
            strong: "border-violet-400 bg-violet-500/18",
            soft: "border-violet-300/80 bg-violet-500/6",
            badgeParent: "bg-violet-500 text-violet-950 border-violet-300",
            badgeChild:
              "bg-violet-950/80 text-violet-200 border-violet-400/80",
          },
          {
            strong: "border-amber-400 bg-amber-500/18",
            soft: "border-amber-300/80 bg-amber-500/6",
            badgeParent: "bg-amber-500 text-amber-950 border-amber-300",
            badgeChild: "bg-amber-950/80 text-amber-200 border-amber-400/80",
          },
          {
            strong: "border-rose-400 bg-rose-500/18",
            soft: "border-rose-300/80 bg-rose-500/6",
            badgeParent: "bg-rose-500 text-rose-950 border-rose-300",
            badgeChild: "bg-rose-950/80 text-rose-200 border-rose-400/80",
          },
          {
            strong: "border-teal-400 bg-teal-500/18",
            soft: "border-teal-300/80 bg-teal-500/6",
            badgeParent: "bg-teal-500 text-teal-950 border-teal-300",
            badgeChild: "bg-teal-950/80 text-teal-200 border-teal-400/80",
          },
        ];

        function createNodeBox(node, level) {
          const box = document.createElement("button");
          box.type = "button";
          box.dataset.id = node.id;

          // ë ˆë²¨ì— ë”°ë¼ ìƒ‰ìƒì„ êµ¬ë¶„
          // - level 0(ìµœìƒìœ„): ìì‹ ê´€ê³„ì™€ ë¬´ê´€í•œ ë³„ë„ ìƒ‰ìƒ(ìŠ¬ë ˆì´íŠ¸ ê³„ì—´)
          // - level 1ë¶€í„°: ë¸Œëœì¹˜ë³„ ìƒ‰ìƒ ê³„ì—´ + ì±„ë„ ì°¨ì´ë¡œ ë¶€ëª¨-ìì‹ êµ¬ë¶„
          let styleClass;
          if (level === 0) {
            // ë£¨íŠ¸: ìŠ¬ë ˆì´íŠ¸/ì¸ë””ê³  ê³„ì—´, êµ¬ì¡° ì „ì²´ì˜ ì‹œì‘ì  ëŠë‚Œ
            styleClass = "border-slate-500 bg-slate-900/80 shadow-md";
          } else {
            const branchIndex =
              typeof node.branchColorIndex === "number"
                ? node.branchColorIndex % branchStyles.length
                : 0;
            const palette = branchStyles[branchIndex];
            // 1ë ˆë²¨(ë¸Œëœì¹˜ ë£¨íŠ¸)ì€ ê°•í•œ ìƒ‰, ê·¸ ì•„ë˜ ë ˆë²¨ì€ ì˜…ì€ ìƒ‰
            styleClass = level === 1 ? palette.strong : palette.soft;
          }

          box.className =
            "group relative text-left rounded-xl px-3 py-2 shadow-lg hover:shadow-2xl hover:border-emerald-400/80 hover:bg-slate-900/90 transition-all duration-300 flex flex-col gap-0.5 min-w-[170px] border hover:scale-105 hover:-translate-y-1 glow-border " +
            styleClass;

          // ë ˆë²¨ì— ë”°ë¥¸ ë±ƒì§€/ë¼ë²¨ êµ¬ë¶„
          let depthBadge;
          let roleLabel;

          if (level === 0) {
            depthBadge =
              '<span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-slate-200 text-slate-950 text-[9px] font-semibold">R</span>';
            roleLabel =
              '<span class="px-1.5 py-0.5 rounded-full bg-slate-800/90 text-slate-200 border border-slate-500/70 text-[9px] tracking-wide">ROOT</span>';
          } else {
            const branchIndex =
              typeof node.branchColorIndex === "number"
                ? node.branchColorIndex % branchStyles.length
                : 0;
            const palette = branchStyles[branchIndex];

            depthBadge = `<span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-slate-950 text-slate-100 border ${level === 1 ? palette.badgeParent.split(" ").find(c=>c.startsWith("border-")) : palette.badgeChild.split(" ").find(c=>c.startsWith("border-"))} text-[9px]">${level}</span>`;

            if (level === 1) {
              roleLabel = `<span class="px-1.5 py-0.5 rounded-full text-[9px] tracking-wide ${palette.badgeParent}">PARENT</span>`;
            } else {
              roleLabel = `<span class="px-1.5 py-0.5 rounded-full text-[9px] tracking-wide ${palette.badgeChild}">CHILD</span>`;
            }
          }

          const urlDisplay = node.url
            ? "/" + node.url.replace(/^\/+/, "")
            : "-";

          box.innerHTML = `
            <div class="flex items-center justify-between gap-1 mb-0.5">
              <div class="flex items-center gap-1">
                ${depthBadge}
                <span class="text-[11px] font-semibold truncate max-w-[140px]">${node.title || "(ì œëª© ì—†ìŒ)"}</span>
              </div>
              <span class="opacity-0 group-hover:opacity-100 text-[9px] text-emerald-300">í¸ì§‘</span>
            </div>
            <div class="flex items-center justify-between gap-1 mb-0.5">
              ${roleLabel}
              <span class="text-[9px] text-slate-400 font-mono truncate max-w-[90px] text-right">${urlDisplay}</span>
            </div>
            ${
              node.description
                ? `<div class="text-[10px] text-slate-400 line-clamp-2">${node.description}</div>`
                : ""
            }
          `;

          box.addEventListener("click", () => {
            enterEditMode(node.id);
          });

          return box;
        }

        function renderLevel(nodes, level) {
          const levelCol = document.createElement("div");
          levelCol.className =
            "flex flex-col gap-3" +
            (level > 0 ? " relative pl-6 border-l border-slate-800/80" : "");

          nodes.forEach((node) => {
            const nodeWrapper = document.createElement("div");
            nodeWrapper.className =
              "flex flex-col gap-2" +
              (level > 0
                ? " before:absolute before:-left-[5px] before:top-4 before:w-3 before:border-t before:border-slate-800/80"
                : "");

            const boxRow = document.createElement("div");
            boxRow.className = "flex flex-wrap gap-2";

            const box = createNodeBox(node, level);
            boxRow.appendChild(box);
            nodeWrapper.appendChild(boxRow);

            if (node.children && node.children.length) {
              const childContainer = renderLevel(node.children, level + 1);
              nodeWrapper.appendChild(childContainer);
            }

            levelCol.appendChild(nodeWrapper);
          });

          return levelCol;
        }

        // ìµœìƒìœ„ ë©”ë‰´(ë£¨íŠ¸)ë¥¼ ì¢Œìš°ë¡œ ë‚˜ë€íˆ ë°°ì¹˜
        tree.forEach((root) => {
          const rootColumn = document.createElement("div");
          rootColumn.className =
            "flex flex-col gap-3 min-w-[220px] max-w-[260px]";

          const rootBlock = renderLevel([root], 0);
          rootColumn.appendChild(rootBlock);
          rootContainer.appendChild(rootColumn);
        });

        sitemapContainer.appendChild(rootContainer);
      }

      // JSON ë‚´ë³´ë‚´ê¸° (ê³„ì¸µ êµ¬ì¡° ê¸°ì¤€)
      function exportJson() {
        if (!pages.length) {
          alert("ë‚´ë³´ë‚¼ ì‚¬ì´íŠ¸ë§µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const tree = buildTree();

        function cleanNode(node) {
          const { id, title, url, parentId, description, createdAt } = node;
          const base = { id, title, url, parentId, description, createdAt };
          if (node.children && node.children.length) {
            return {
              ...base,
              children: node.children.map(cleanNode),
            };
          }
          return base;
        }

        const exportData = tree.map(cleanNode);
        const blob = new Blob([JSON.stringify(exportData, null, 2)], {
          type: "application/json;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "sitemap-structure.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // í¸ì§‘ ëª¨ë“œ ì§„ì…
      function enterEditMode(id) {
        const page = pages.find((p) => p.id === id);
        if (!page) return;
        editingIdInput.value = page.id;
        fillForm(page);

        // ìˆ˜ì • / ì‚­ì œ ë²„íŠ¼ í™œì„±í™”
        updateButton.disabled = false;
        updateButton.classList.remove("opacity-40", "cursor-not-allowed");

        deleteButton.disabled = false;
        deleteButton.classList.remove("opacity-40", "cursor-not-allowed");

        // ì¶”ê°€ ë²„íŠ¼ì€ ê·¸ëŒ€ë¡œ ë‘ê³ , í•„ìš” ì‹œ ë³„ë„ ìŠ¤íƒ€ì¼ ì¡°ì • ê°€ëŠ¥
        refreshParentOptions();
      }

      // í˜ì´ì§€ ì‚­ì œ
      function deletePage(id) {
        const hasChildren = pages.some((p) => p.parentId === id);
        if (
          hasChildren &&
          !confirm(
            "ì´ í˜ì´ì§€ì˜ í•˜ìœ„ í˜ì´ì§€ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
          )
        ) {
          return;
        }

        // íˆìŠ¤í† ë¦¬ì— í˜„ì¬ ìƒíƒœ ì €ì¥
        saveStateToHistory();

        // í•˜ìœ„ í¬í•¨ ì¬ê·€ ì‚­ì œ
        function deleteRec(targetId) {
          const idx = pages.findIndex((p) => p.id === targetId);
          if (idx >= 0) {
            pages.splice(idx, 1);
          }
          const children = pages.filter((p) => p.parentId === targetId);
          children.forEach((c) => deleteRec(c.id));
        }
        deleteRec(id);

        if (editingIdInput.value === id) {
          resetForm();
        }

        refreshParentOptions();
        renderTable();
        renderSitemap();

        // ìë™ ì €ì¥
        autoSave();
      }

      // ì „ì²´ í¼ì¹˜ê¸° / ì ‘ê¸° (ê°„ë‹¨ êµ¬í˜„: ì ‘ê¸°ëŠ” ìµœìƒìœ„ë§Œ, í¼ì¹˜ê¸°ëŠ” ëª¨ë‘ í‘œì‹œ)
      function collapseAll() {
        if (!pages.length) return;
        const tree = buildTree();
        const reducedTree = tree.map((n) => ({ ...n, children: [] }));

        sitemapContainer.innerHTML = "";
        const rootContainer = document.createElement("div");
        rootContainer.className =
          "flex flex-col gap-3 text-[11px] text-slate-100";

        const levelView = document.createElement("div");
        levelView.className = "flex flex-wrap gap-2";
        reducedTree.forEach((node) => {
          const box = document.createElement("button");
          box.type = "button";
          box.dataset.id = node.id;
          box.className =
            "relative text-left rounded-lg border bg-slate-900/90 px-3 py-2 shadow-sm hover:border-emerald-500/80 hover:bg-slate-900 transition flex flex-col gap-0.5 min-w-[150px]";
          box.innerHTML = `
            <div class="flex items-center justify-between gap-1 mb-0.5">
              <span class="text-[11px] font-medium truncate max-w-[140px]">${node.title}</span>
              <span class="text-[9px] text-slate-400 font-mono truncate max-w-[80px]">${node.url ? "/" + node.url : "-"}</span>
            </div>
          `;
          box.addEventListener("click", () => enterEditMode(node.id));
          levelView.appendChild(box);
        });

        rootContainer.appendChild(levelView);
        sitemapContainer.appendChild(rootContainer);
      }

      function expandAll() {
        renderSitemap();
      }

      // ì´ë²¤íŠ¸ ë°”ì¸ë”©
      // í˜ì´ì§€ ì¶”ê°€
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const data = getFormData();
        if (!data.title) {
          alert("í˜ì´ì§€ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        // íˆìŠ¤í† ë¦¬ì— í˜„ì¬ ìƒíƒœ ì €ì¥
        saveStateToHistory();

        // ìƒˆë¡œ ì¶”ê°€
        const newPage = {
          id: createId(),
          ...data,
          order: pages.length, // ìˆœì„œ í•„ë“œ ì¶”ê°€
          createdAt: new Date().toISOString(),
        };
        pages.push(newPage);

        refreshParentOptions();
        renderTable();
        renderSitemap();
        resetForm();

        // ìë™ ì €ì¥
        autoSave();
      });

      // í˜ì´ì§€ ìˆ˜ì •
      updateButton.addEventListener("click", () => {
        const editingId = editingIdInput.value;
        if (!editingId) {
          alert("ìˆ˜ì •í•  í˜ì´ì§€ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }
        const data = getFormData();
        if (!data.title) {
          alert("í˜ì´ì§€ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        // íˆìŠ¤í† ë¦¬ì— í˜„ì¬ ìƒíƒœ ì €ì¥
        saveStateToHistory();

        const idx = pages.findIndex((p) => p.id === editingId);
        if (idx >= 0) {
          pages[idx] = { ...pages[idx], ...data };
        }
        refreshParentOptions();
        renderTable();
        renderSitemap();
        resetForm();

        // ìë™ ì €ì¥
        autoSave();
      });

      // í˜ì´ì§€ ì‚­ì œ (ì„ íƒëœ í˜ì´ì§€ ê¸°ì¤€, ê¸°ì¡´ ì‚­ì œ ë¡œì§ ì¬ì‚¬ìš©)
      deleteButton.addEventListener("click", () => {
        const editingId = editingIdInput.value;
        if (!editingId) {
          alert("ì‚­ì œí•  í˜ì´ì§€ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }
        deletePage(editingId);
      });

      // í”„ë¡œì íŠ¸ ì„ íƒ ë³€ê²½
      projectSelect.addEventListener("change", () => {
        const targetId = projectSelect.value;
        if (targetId && targetId !== currentProjectId) {
          setCurrentProject(targetId);
        }
      });

      // ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±
      newProjectButton.addEventListener("click", async () => {
        let name = prompt("ìƒˆ í”„ë¡œì íŠ¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.", "ìƒˆ í”„ë¡œì íŠ¸");
        if (name === null) return; // ì·¨ì†Œ
        name = name.trim();
        if (!name) {
          name = `í”„ë¡œì íŠ¸ ${projects.length + 1}`;
        }
        const project = createProject(name);
        setCurrentProject(project.id);
        
        // í”„ë¡œì íŠ¸ ìƒì„± í›„ ì¦‰ì‹œ ì €ì¥
        try {
          await saveProject();
        } catch (error) {
          console.error("í”„ë¡œì íŠ¸ ìƒì„± í›„ ì €ì¥ ì˜¤ë¥˜:", error);
          // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ í”„ë¡œì íŠ¸ëŠ” ìƒì„±ë˜ì—ˆìœ¼ë¯€ë¡œ ê³„ì† ì§„í–‰
        }
      });

      // í”„ë¡œì íŠ¸ ì‚­ì œ ë²„íŠ¼
      deleteProjectButton.addEventListener("click", deleteProject);

      // í”„ë¡œì íŠ¸ ì €ì¥ ë²„íŠ¼
      saveProjectButton.addEventListener("click", saveProject);

      expandAllBtn.addEventListener("click", expandAll);
      collapseAllBtn.addEventListener("click", collapseAll);
      exportJsonBtn.addEventListener("click", exportJson);

      // Undo/Redo ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById('undo-button').addEventListener('click', undo);
      document.getElementById('redo-button').addEventListener('click', redo);

      // ë³µì‚¬/ë¶™ì—¬ë„£ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById('paste-button').addEventListener('click', pastePage);

      // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
      document.addEventListener('keydown', (e) => {
        // ì…ë ¥ í•„ë“œì—ì„œëŠ” ë‹¨ì¶•í‚¤ ë¬´ì‹œ
        if (e.target.tagName === 'INPUT' ||
            e.target.tagName === 'TEXTAREA' ||
            e.target.tagName === 'SELECT') {
          return;
        }

        // Ctrl+Z: Undo
        if (e.ctrlKey && e.key === 'z') {
          e.preventDefault();
          undo();
        }

        // Ctrl+Y: Redo
        if (e.ctrlKey && e.key === 'y') {
          e.preventDefault();
          redo();
        }

        // Ctrl+V: Paste
        if (e.ctrlKey && e.key === 'v') {
          e.preventDefault();
          pastePage();
        }
      });

      // ì´ˆê¸° í”„ë¡œì íŠ¸ ìƒì„± ë° ë Œë”
      (async function initProjects() {
        // ì €ì¥ëœ í”„ë¡œì íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œë„
        const loaded = await loadProjects();
        if (!loaded) {
          // ì €ì¥ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ í”„ë¡œì íŠ¸ ìƒì„±
          const defaultProject = createProject("ê¸°ë³¸ í”„ë¡œì íŠ¸");
          setCurrentProject(defaultProject.id);
        } else {
          // ì €ì¥ëœ í”„ë¡œì íŠ¸ê°€ ìˆìœ¼ë©´ UI ê°±ì‹ 
          refreshProjectSelect();
        }

        // Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” ì„¤ì •
        if (isFirebaseConfigured) {
          setupRealtimeSync();
          updateFirebaseStatus(true);
        } else {
          updateFirebaseStatus(false);
        }
      })();

      // Firebase ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
      function updateFirebaseStatus(connected) {
        if (!firebaseStatus) return;
        
        if (connected) {
          firebaseStatus.textContent = "ğŸŸ¢ ì‹¤ì‹œê°„ ë™ê¸°í™”";
          firebaseStatus.classList.remove("hidden", "border-slate-700", "bg-slate-900/60");
          firebaseStatus.classList.add("border-emerald-500/70", "bg-emerald-500/10", "text-emerald-200");
          firebaseStatus.title = "Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” í™œì„±í™”ë¨";
        } else {
          firebaseStatus.textContent = "âšª ë¡œì»¬ ì €ì¥";
          firebaseStatus.classList.remove("hidden", "border-emerald-500/70", "bg-emerald-500/10", "text-emerald-200");
          firebaseStatus.classList.add("border-slate-700", "bg-slate-900/60");
          firebaseStatus.title = "Firebaseê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ. localStorageë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.";
        }
      }
    </script>
  </body>
</html>


